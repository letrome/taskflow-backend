name: Update Release Notes

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-release-notes:
    name: Update Release Notes from Changelog
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Extract release notes
        id: extract_notes
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          # Extract the content between the version header and the next header
          NOTES=$(awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)

          if [ -z "$NOTES" ]; then
            echo "::warning::No release notes found for version $VERSION in CHANGELOG.md"
            exit 0
          fi

          # Use a random delimiter for the hereditary document to avoid conflicts
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "notes<<$EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Update Release
        if: steps.extract_notes.outputs.notes != ''
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.extract_notes.outputs.notes }}
