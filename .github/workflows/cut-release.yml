name: Cut Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g. 0.0.2)"
        required: true
        type: string

permissions:
  contents: write
  packages: write

jobs:
  cut-release:
    name: Cut Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update Version
        run: |
          npm version ${{ inputs.version }} --no-git-tag-version

      - name: Commit and Push
        run: |
          git add package.json
          git commit -m "chore: release v${{ inputs.version }}"
          git push origin HEAD

      - name: Extract release notes
        id: extract_notes
        run: |
          VERSION="${{ inputs.version }}"
          # Extract the content between the version header and the next header
          NOTES=$(awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)

          if [ -z "$NOTES" ]; then
            echo "::warning::No release notes found for version $VERSION in CHANGELOG.md"
            # Fallback to empty if not found, or standard text
            NOTES="No release notes available for v$VERSION"
          fi

          # Use a random delimiter for the hereditary document to avoid conflicts
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "notes<<$EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          target_commitish: main
          generate_release_notes: false
          body: ${{ steps.extract_notes.outputs.notes }}

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=${{ inputs.version }}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_RELEASE_URL }}
          SLACK_CHANNEL: taskflow-backend-deploy
          SLACK_COLOR: ${{ job.status == 'success' && 'good' || 'danger' }}
          SLACK_ICON: https://github.com/rtCamp.png?size=48
          SLACK_MESSAGE: "Release finished with status: ${{ job.status }}"
          SLACK_TITLE: Release Status
          SLACK_USERNAME: GitHub Actions